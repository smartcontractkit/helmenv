apiVersion: v1
kind: ConfigMap
metadata:
  labels:
    app: remote-test-runner-cm
    release: {{ .Release.Name }}
  name: remote-test-runner-cm
data:
  test-env.json: |
    {{ .Values.remote_test_runner.config_file_contents }}
  init.sh: |
    #!/bin/sh

    for i in 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20
    do
      if [ -f "$TEST_FILE" ]
      then
        echo "$TEST_FILE found!"
        CURRENT_FILE_SIZE=$(stat -c%s "$TEST_FILE")
        echo "File is currently $CURRENT_FILE_SIZE bytes, waiting for it to be $TEST_FILE_SIZE bytes"
        if [ "$CURRENT_FILE_SIZE" -eq "$TEST_FILE_SIZE" ]
        then
          chmod +x $TEST_FILE
          file $TEST_FILE
          $TEST_FILE --ginkgo.timeout=0 --ginkgo.v --ginkgo.focus {{ .Values.remote_test_runner.test_name }}
          break
        else
          echo "$TEST_FILE is still being copied, waiting for copy process to finish"
          echo "These processes are still working on the file"
          lsof "$TEST_FILE"
        fi
        echo "Waiting for copy process to finalize"
      fi
      ls /root
      sleep 30
    done

    echo "Either the test has completed, or the test file failed to be uploaded in time"
