apiVersion: v1
kind: ConfigMap
metadata:
  labels:
    app: remote-test-runner-cm
    release: {{ .Release.Name }}
  name: remote-test-runner-cm
data:
  test-env.json: |
    {{ .Values.remote_test_runner.config_file_contents }}
  init.sh: |
    #!/bin/sh

    echo "Waiting for config files"
    until [ -f $FRAMEWORK_CONFIG_FILE ]
    do
      sleep 1
    done
    echo "Found $FRAMEWORK_CONFIG_FILE"

    until [ -f $NETWORKS_CONFIG_FILE ]
    do
      sleep 1
    done
    echo "Found $NETWORKS_CONFIG_FILE"

    echo "Installing dependencies"
    apk add build-base

    chmod +x $TEST_FILE
    echo "File details"
    stat $TEST_FILE
    echo "-----------"
    file $TEST_FILE
    echo "-----------"
    ldd $TEST_FILE
    echo "-----------"

    echo "Running test..."
    $TEST_FILE --ginkgo.timeout=0 --ginkgo.v --ginkgo.focus {{ .Values.remote_test_runner.test_name }}
